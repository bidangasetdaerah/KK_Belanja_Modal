<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Dokumen Pendukung SP2D</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @media (max-width: 640px) {
      table { display: none; }
      .card-list { display: block; }
    }
    @media (min-width: 641px) {
      .card-list { display: none; }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-4 sm:p-6">

<h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center">
  Upload Dokumen Pendukung SP2D
</h1>

<div class="bg-white shadow rounded-lg p-4 sm:p-6 max-w-6xl mx-auto">

  <p id="infoJumlah" class="mb-4 text-sm font-medium text-gray-700"></p>

  <input
    type="text"
    id="searchBox"
    placeholder="Cari Nama SKPD / Belanja..."
    class="border rounded p-2 mb-4 w-full sm:w-72"
    oninput="applyFilters()"
  />

  <!-- TABLE DESKTOP -->
  <table class="table-auto w-full border-collapse border text-sm">
    <thead class="bg-gray-200">
      <tr>
        <th class="border p-2">Nama SKPD</th>
        <th class="border p-2">Nilai SP2D</th>
        <th class="border p-2">Belanja</th>
        <th class="border p-2">Dokumen</th>
        <th class="border p-2">Aksi</th>
      </tr>
    </thead>
    <tbody id="tabelData"></tbody>
  </table>

  <!-- CARD MOBILE -->
  <div id="cardList" class="card-list space-y-4"></div>

  <!-- PAGINATION -->
  <div class="flex justify-center items-center gap-3 mt-4">
    <button onclick="prevPage()" class="px-3 py-1 bg-gray-200 rounded">Prev</button>
    <span id="pageInfo" class="text-sm"></span>
    <button onclick="nextPage()" class="px-3 py-1 bg-gray-200 rounded">Next</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzIKYYWfuJ5H9AzkHPguiSq7uKBNviSFWP4kEVeIcL_8CQ-3VuGW1p6w5JAMc7XjkW2ig/exec";

let allData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 10;

/* ========= UTIL ========= */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ========= LOAD DATA ========= */
async function loadData() {
  const res = await fetch(`${WEB_APP_URL}?action=getUploadData`);
  allData = await res.json();
  filteredData = allData;
  render();
}

/* ========= FILTER ========= */
function applyFilters() {
  const key = document.getElementById("searchBox").value.toLowerCase();
  filteredData = allData.filter(d =>
    d.namaSKPD.toLowerCase().includes(key) ||
    d.belanja.toLowerCase().includes(key)
  );
  currentPage = 1;
  render();
}

/* ========= RENDER ========= */
function render() {
  const tabel = document.getElementById("tabelData");
  const cardList = document.getElementById("cardList");
  tabel.innerHTML = "";
  cardList.innerHTML = "";

  const start = (currentPage - 1) * rowsPerPage;
  const pageData = filteredData.slice(start, start + rowsPerPage);

  pageData.forEach((item, i) => {
    const uid = start + i;
    const uploaded = item.dokumen && item.dokumen.startsWith("http");

    tabel.innerHTML += `
      <tr>
        <td class="border p-2">${item.namaSKPD}</td>
        <td class="border p-2 text-right">Rp ${Number(item.nilaiSP2D).toLocaleString("id-ID")}</td>
        <td class="border p-2">${item.belanja}</td>
        <td class="border p-2 text-center">
          ${uploaded ? `<a href="${item.dokumen}" target="_blank" class="text-blue-600 underline">Lihat</a>` : "-"}
        </td>
        <td class="border p-2 text-center">
          <input type="file" id="file-${uid}" accept=".pdf,.jpg,.jpeg,.png"
            class="text-xs mb-1" ${uploaded ? "disabled" : ""}>
          <button onclick="uploadFile(${uid}, '${item.namaSKPD}')"
            class="px-2 py-1 text-xs rounded ${uploaded ? "bg-gray-400" : "bg-green-600 text-white"}"
            ${uploaded ? "disabled" : ""}>
            Upload
          </button>
          <p id="status-${uid}" class="text-xs mt-1"></p>
        </td>
      </tr>
    `;

    cardList.innerHTML += `
      <div class="border rounded p-3 shadow">
        <p class="font-semibold">${item.namaSKPD}</p>
        <p class="text-sm">SP2D: Rp ${Number(item.nilaiSP2D).toLocaleString("id-ID")}</p>
        <p class="text-sm">Belanja: ${item.belanja}</p>
        <p class="text-sm">Dokumen: ${uploaded ? `<a href="${item.dokumen}" class="text-blue-600 underline">Lihat</a>` : "-"}</p>
        <input type="file" id="file-m-${uid}" accept=".pdf,.jpg,.jpeg,.png"
          class="text-xs mt-2" ${uploaded ? "disabled" : ""}>
        <button onclick="uploadFile(${uid}, '${item.namaSKPD}', true)"
          class="mt-2 w-full text-xs px-2 py-1 rounded ${uploaded ? "bg-gray-400" : "bg-green-600 text-white"}"
          ${uploaded ? "disabled" : ""}>
          Upload
        </button>
        <p id="status-m-${uid}" class="text-xs mt-1"></p>
      </div>
    `;
  });

  document.getElementById("pageInfo").textContent =
    `Halaman ${currentPage} dari ${Math.ceil(filteredData.length / rowsPerPage)}`;

  document.getElementById("infoJumlah").textContent =
    `Dokumen terunggah: ${allData.filter(d => d.dokumen && d.dokumen.startsWith("http")).length}
     dari ${allData.length}`;
}

/* ========= PAGINATION ========= */
function prevPage() { if (currentPage > 1) { currentPage--; render(); } }
function nextPage() {
  if (currentPage < Math.ceil(filteredData.length / rowsPerPage)) {
    currentPage++; render();
  }
}

/* ========= UPLOAD ========= */
async function uploadFile(uid, namaSKPD, mobile = false) {
  const fileInput = document.getElementById(mobile ? `file-m-${uid}` : `file-${uid}`);
  const status = document.getElementById(mobile ? `status-m-${uid}` : `status-${uid}`);

  if (!fileInput.files.length) return alert("Pilih file dulu");

  const file = fileInput.files[0];
  if (file.size > 5 * 1024 * 1024) return alert("Maksimal 5MB");

  status.textContent = "Mengunggah...";

  const base64 = await fileToBase64(file);

  const res = await fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "uploadFile",
      namaSKPD,
      base64: base64.split(",")[1],
      mimeType: file.type
    })
  });

  const result = await res.json();

  if (result.success) {
    status.innerHTML = `Berhasil: <a href="${result.fileUrl}" target="_blank" class="text-blue-600 underline">Lihat</a>`;
    allData.find(d => d.namaSKPD === namaSKPD).dokumen = result.fileUrl;
    render();
  } else {
    status.textContent = "Upload gagal";
  }
}

loadData();
</script>
</body>
</html>
